@model PagedList.IPagedList<NDHSITE.Models.StaffCheckIn>
@using PagedList.Mvc;
@{
    ViewBag.Title = "ShowCheckIn";
}
<div class="page-header">
    <h3 class="page-title">Danh sách nhân viên checkin</h3>

    <ol class="breadcrumb">
        <li><a href="/home">Trang chủ</a></li>
        <li><a href="#">Nhân viên checkin</a></li>
    </ol>
</div> <!-- /.page-header -->


<form method="get">
    <div class="row">

        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label>Chi nhánh</label>
                        <select class="form-control selectpicker" data-live-search="true" name="brand" id="allbrand" @(ViewBag.IsDisable == 1?"disabled":"") >

                            @if (ViewBag.BranchId == "-1")
                            {
                                <option data-tokens="Tất cả" value="-1" selected>Tất cả chi nhánh</option>
                            }
                            else
                            {
                                <option data-tokens="Tất cả" value="-1">Tất cả chi nhánh</option>
                            }


                            @foreach (var item in ViewBag.Branchs)
                            {
                                if (ViewBag.BranchId == item.Id)
                                {
                                    <option data-tokens="@item.Name @item.Code" value="@item.Id" selected>@item.Name - @item.Code</option>
                                }
                                else
                                {
                                    <option data-tokens="@item.Name @item.Code" value="@item.Id">@item.Name - @item.Code</option>
                                }

                            }
                        </select>
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label>Nhập mã hoặc tên nhân viên</label>
                        <input type="text" class="form-control" name="search" placeholder="Mã hoặc tên" value="@ViewBag.SearchText" />
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group">
                        <label>Từ ngày</label>
                        <input type="text" class="form-control" id="datefrom" name="DateFrom" value="@ViewBag.DateFrom" />
                    </div>
                </div>

                <div class="col-sm-12">
                    <div class="form-group">
                        <label>Đến ngày</label>
                        <input type="text" class="form-control" id="dateto" name="DateTo" value="@ViewBag.DateTo" />
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="row">
        <div class="col-sm-1">
            <div class="form-group">
                <button class="btn btn-primary" type="submit">Xem</button>
            </div>
        </div>
        <div class="col-sm-4">
            <div class="form-group">
                <a class="btn btn-info" href="@Url.Action("ExportCheckIn", new { brand = ViewBag.BranchId, search = ViewBag.SearchText, DateFrom = ViewBag.DateFrom, DateTo = ViewBag.DateTo })">Xuất Excel</a>
            </div>
        </div>
    </div>
</form>

<div class="portlet portlet-boxed">
    <div class="portlet-body">

        <div class="table-responsive">

            <table class="table table-striped table-bordered thumbnail-table">
                <thead>
                    <tr>
                        <th style="width: 150px">Hình ảnh</th>
                        <th>Nội dụng checkin</th>
                        <th>Thông tin nhân viên</th>
                    </tr>
                </thead>

                <tbody>

                    @foreach (var item in Model)
                    {
                        <tr>
                            <td class="valign-middle">
                                <div class="thumbnail">
                                    <div class="thumbnail-view">
                                        <a href="@item.ImageUrl" class="image-link" title="@item.StaffUser">
                                            <img src="@item.ImageUrl" alt="@item.StaffUser" class="img-responsive" width="125" />
                                        </a>
                                    </div>
                                </div> <!-- /.thumbnail -->
                            </td>

                            <td class="valign-middle">
                                <span><strong class="semibold">Nội dung:</strong> @item.Comment</span> <br />
                                <span>
                                    <strong class="semibold">Ngày giờ:</strong>
                                    @if (item.AcceptTime != null)
                                    {
                                        @item.AcceptTime.Value.ToString("dd/MM/yyyy HH:mm")
                                    }
                                    else
                                    {
                                        @item.CreateDate.Value.ToString("dd/MM/yyyy HH:mm")
                                    }
                                </span> <br />
                                <span>
                                    <strong class="semibold">Khách hàng:</strong>
                                    @if (item.AgencyType == "CI")
                                    {
                                        <a href="/showinfo/showci?type=1&areaId=-1&search=@item.Agency" target="_blank">@item.Agency - @item.AgencyName</a>
                                    }
                                    else if (item.AgencyType == "CII")
                                    {
                                        <a href="/showinfo/showcii?type=1&areaId=-1&search=@item.Agency" target="_blank">@item.Agency - @item.AgencyName</a>
                                    }
                                    else
                                    {
                                        <a>Không tìm thấy</a>
                                    }
                                </span><br />
                                <span><strong class="semibold">Loại đại lý:</strong> @item.AgencyTypeName</span><br />
                                <span><strong class="semibold">Địa chỉ:</strong> @item.AgencyAddress</span><br />
                                <span><strong class="semibold">Tọa độ:</strong> (@item.Latitude, @item.Longitude)</span>
                            </td>

                            <td class="file-info valign-middle">
                                <span><strong class="semibold">Nhân viên:</strong> @item.HaiStaff.FullName</span> <br />
                                <span><strong class="semibold">Mã nhân viên:</strong> @item.HaiStaff.Code</span> <br />
                                <span><strong class="semibold">Chi nhánh:</strong> @item.HaiStaff.HaiBranch.Name</span> <br />
                                <span><strong class="semibold">Khu vực:</strong> @item.HaiStaff.HaiBranch.HaiArea.Name</span> <br />
                                <span><strong class="semibold">chức vụ:</strong> @item.HaiStaff.HaiPosition.Name</span> <br />
                                <span><strong class="semibold">Tài khoản:</strong> @item.HaiStaff.UserLogin</span>

                            </td>
                        </tr>
                    }


                </tbody>
            </table>
            Page @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) of @Model.PageCount
            @Html.PagedListPager(Model, page => Url.Action("showcheckin",
                                                         new { page, brand = ViewBag.BranchId, search = ViewBag.SearchText, DateFrom = ViewBag.DateFrom, DateTo = ViewBag.DateTo }))
        </div> <!-- /.table-responsive -->

    </div> <!-- /.portlet-body -->

</div> <!-- /.portlet -->

<div id="map"></div>

@section styles {
    <style>
        #map {
            height: 500px;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css" rel="stylesheet" />

    <!-- bootstrap select-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.11.0/css/bootstrap-select.min.css">
    <link href="~/content/bootstrap-datetimepicker.min.css" rel="stylesheet">
}

@section scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.11.0/js/bootstrap-select.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('.image-link').magnificPopup({
                type: 'image',
                closeBtnInside: false,
                closeOnContentClick: true,

                image: {
                    verticalFit: true,
                    titleSrc: function (item) {
                        return item.el.attr('title') + ' &middot; <a class="image-source-link" href="' + item.src + '" target="_blank">open original</a>';
                    }
                }

            });
        });
    </script>


    <!-- date bootstrap -->
    <script src="~/Scripts/moment.min.js"></script>
    <script src="~/scripts/moment-with-locales.min.js"></script>
    <script src="~/scripts/bootstrap-datetimepicker.min.js"></script>

    <script type="text/javascript">
        $('#dateto').datetimepicker({
            locale: 'vi',
            format: 'MM/DD/YYYY',
            defaultDate: new Date()
        });
        $('#datefrom').datetimepicker({
            locale: 'vi',
            format: 'MM/DD/YYYY',
            defaultDate: new Date()
        });
    </script>



    <script>
        function initMap() {

            var lats = [];
            var longs = [];
            var images = [];
            var contents = [];
            var users = [];

            @foreach (var d in Model)
            {
                @:lats.push(@d.Latitude);
                                                                                                                                                    @:longs.push(@d.Longitude);
                                                                                                                                                    @:images.push("@d.ImageUrl");
                                                                                                                                                    @:contents.push("@d.Comment")
                                                                                                                                                    @:users.push("@d.HaiStaff.FullName - @d.StaffUser");
                                                                                                                                                }

            console.log(lats);

            if (users.length > 0) {
                var uluru = { lat: lats[0], lng: longs[0] };
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: new google.maps.LatLng(lats[0], longs[0]),
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });

                var size = users.length;
                var marker;


                for (var i = 0; i < size; i++) {
                    var infowindow = new google.maps.InfoWindow();
                    var contentString = '<div id="content">' +
                    '<div id="siteNotice">' +
                    '</div>' +
                    '<h3 id="firstHeading" class="firstHeading">' + users[i] + '</h3>' +
                    '<div id="bodyContent">' +
                    '<p>' + contents[i] + '</p>' +
                    '<p>Hình ảnh: <a href="' + images[i] + '" class="image-link" title="' + users[i] + '"><img src="' + images[i] + '" alt="' + users[i] + '" class="img-responsive" width="200" /></a> '
                    '</div>' +
                    '</div>';
                    console.log(contentString);
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(lats[i], longs[i]),
                        map: map
                    });


                    google.maps.event.addListener(marker, 'click', (function (marker, contentString, infowindow) {
                        return function () {
                            infowindow.setContent(contentString);
                            infowindow.open(map, marker);
                        }
                    })(marker, contentString, infowindow));

                }
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxmT8JcH0I9a2TR1KvraY4ACuI9c6ziys&callback=initMap"
        async defer></script>


}